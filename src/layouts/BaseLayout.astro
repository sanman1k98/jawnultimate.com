---
import '@/styles/tailwind.css';
import '@/styles/fonts.css';
import { z } from 'astro/zod';

// Shows up in browser tabs.
const SITE_NAME = 'JAWN';

const DEFAULTS = {
	LANG: 'en-US',
	OG_IMAGE: { file: '' },
	TWITTER: { site: undefined },
};

const basic = z.object({
	/** Language tag (BCP 47). */
	locale: z.string().default(DEFAULTS.LANG),
	/** Text to display in the browser tab. */
	title: z.string(),
	/** Use to set the `<title>` text manually. */
	rawTitle: z.string().optional(),
	/** A description for creating a bookmark for the page. */
	description: z.string(),
	author: z.string().optional(),
});

const articleSchema = z.object({
	published_time: z.coerce.date(),
	modified_time: z.coerce.date(),
});

/** @see https://ogp.me */
const ogSchema = z.object({
	/** A more descriptive title used by the OpenGraph protocol. */
	title: z.string().optional(),
	/** A description of the page used by the OpenGraph protocol. */
	description: z.string().optional(),
	article: articleSchema.optional(),
	image: z.object({
		/** Path to an image file. */
		file: z.string(),
		/** Alt text for image. */
		alt: z.string().optional(),
	}),
});

// Twitter Cards will use OpenGraph images.
const twitterSchema = z.object({
	card: z.enum(['summary', 'summary_large_image']).default('summary_large_image'),
	/** Username for the website used in the card footer. */
	site: z.string().startsWith('@').optional(),
	/** Username for the content creator or author. */
	creator: z.string().startsWith('@').optional(),
});

const headMeta = basic
	.extend({
		og: ogSchema.default({ image: DEFAULTS.OG_IMAGE }),
		twitter: twitterSchema.default(DEFAULTS.TWITTER),
	})
	.transform((data) => {
		const { og, twitter, ...basic } = data;
		return {
			...basic,
			title: basic.rawTitle ?? [basic.title, SITE_NAME].filter(Boolean).join(' | '),
			twitter,
			og: {
				...og,
				type: og.article ? 'article' : 'website',
				title: og.title ?? basic.title,
				description: og.description ?? basic.description,
			},
		};
	});

export type HeadMetaProps = z.input<typeof headMeta>;

export type Props = HeadMetaProps & {
	/** Will be added to the `<body>` element. */
	class?: string;
};

const { class: className, ...meta } = Astro.props;
const parsed = headMeta.safeParse(meta);

if (!parsed.success || !parsed.data)
	console.error(`Invalid head meta props for %s: %o`, Astro.url.pathname, parsed.error.issues);

const { title, description, locale } = parsed.data! ?? {};
---

<!doctype html>
<html lang={locale}>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, viewport-fit=cover" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		<meta name="description" content={description} />

		<slot name="head" />

		<style>
			@view-transition {
				navigation: auto;
			}
		</style>
	</head>
	<body class:list={[className]}>
		<slot />
	</body>
</html>
